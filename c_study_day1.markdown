
# WebエンジニアのためのC言語入門ハンズオン #1

とりあえずプロダクトアウト！

# 今日習得すること
+ C言語で実行可能ファイルを作成するための最低限の知識
+ メモリ空間とポインターについて 
+ `pwd`コマンドを実装 

# C言語とは? 

習得までに非常に時間がかかる言語である。

> 「Cの罠と落とし穴」とか「Cのパズルブック」とか、「Cとその秘密」といったタイトルの本は山のようにあるのに、
>   他の言語では、その類の本がまったくないことに気づいたことあるかい？その理由をここで明らかにしておこう！
Peter van der Linden (1996). エキスパートCプログラミング -知られざるCの深層 アスキー出版局 23.

Webエンジニアは大抵が下記いずれかの言語を習得していることを前提とします。

+ Ruby
+ PHP
+ Perl
+ Python
+ Java
+ Javascript

本ハンズオンは、すでに他の言語にて基本的なプログラミングの素養がある方を対象に、C言語というものの概要と  
それを独力で学び続けるために必要な、忘れにくい最低限のベース知識を習得することが目的です。

## 諸注意 

ある程度の体系をもってハンズオンを進めて行きますが、網羅的ではないです。  
構造体については、そんなに触れません。

先に記述した通り、習得に長時間がかかるため、忘れにくいベース知識をなんとかつくり上げることに注力します。  

不明点があれば、随時指摘お願いします。

# C言語で実行可能ファイルを作成するための最低限の知識
ざっくりと行きます。

## データ型
+ char
+ int
+ float
+ double

文字列型は無いです。文字列は`char`の配列です。  
文字列の終端はNull文字`\00`で区別されます。  

(余談) Nullバイト攻撃は、C言語の文字列配列の終端文字を狙った攻撃です。

## 文法
+ if else
+ for while
+ switch 
+ サブルーチン(function)
+ break continue
+ gotoと名札

goto以外は、まあ大体の言語でもあると思います。
プログラムの行末にはセミコロンが必要です。すいません。

## 共有ライブラリ
C言語それ自体は、最低限の文法とデータ型を持つのみです。  
そのままでは辛いので、共有ライブラリを`include`して、便利な関数群を使います。

有名なやつ
+ stdio.h  
標準入出力
+ stdlib.h  
メモリ確保とか
+ string.h  
文字列操作

## 演習問題1 写経
(1) 次のプログラムを写経して下さい。  
コピペしないで下さい。一文字一文字心を込めて打ち込んで下さい。

```
#include <stdio.h>

int main(){
    printf("Hello World\n");
}
```

ファイルは、`hello.c`という名前で保存してください。

(2) コンパイル
次のコマンドでコンパイルを行って下さい。

```
gcc -o hello hello.c
```

コンパイル後は、`hello`という名の実行ファイルができています。実行して見てください。  
終わった人は、下記のコマンドでもコンパイルを行って下さい。

```
gcc hello.c
```

何が出来たでしょうか？

(3) このプログラムの1行1行を細かく考えて見ます。

(4) 下記のコマンドを実行して下さい。
+ Linux  
`ldd hello`
+ Mac  
`otool -L hello`

表示された物は何でしょうか？


# メモリ空間
C言語で実装を行う際は、下記の５つのメモリー空間を常に頭に思い浮かべる必要があります。  
自分が書いているコードが、アドレス空間のどこに影響するのか？を常に意識して下さい。

+ スタック
`main`関数がスタックの1番目に入ります。  
以降の関数は、`main`関数から呼び出されると、その上に積み上がっていくイメージです。  
実行が終わった関数は、スタックから取り除かれます。  
StackOverFlowとは、スタックが積み上がりすぎて用意したアドレス空間の範囲外まで達するエラーです。  
再帰呼び出しで無限ループさせると、発生させることが出来ます。
+ ヒープ  
ヒープは、スタックに関係なく、全ての関数からアクセス可能なメモリ空間です。  
いわゆるメモリリークは、ここで発生します。  
+ グローバル
関数外で宣言された変数は、ここに格納されます。グローバル空間です。  
つまり、あまり不用意に使うと、大変なことになります。
+ 定数  
文字列リテラルや、constキーワードで宣言された読み取り専用の変数です。  
ここに格納された変数は、書き換えが出来ません。
+ コード
ソースコードとかが読み込まれている空間です。

C言語を実装する時に、最も多く発生するエラーは、`Segmentation Fault`です。  
上記のアドレス空間は、それぞれがセグメントと呼ばれます。  

`Segmentation Fault`とは、実行中のプログラムが権限の無いアドレス空間・メモリ領域に触れようとしたことを指します。  

# ポインター
難しいと良く聞くやつです。でも、なんてことは無いです。**参照渡し**だと思えば良いです。

概念としては、非常に単純なのですが、それを自分のソースコードで表現するのが難しいです。

## 演習問題1
(1) 下記のソースコードはポインターを使った簡単な演算を行っています。  
ちゃんと動作するプログラムです。写経してコンパイルして実行して下さい。

```
#include <stdio.h>

void add(int * a){
    *a = *a + 3;
}

int main(){
    int a = 1;
    add(&a);
    printf("a = %d\n", a);
}
```

(2) ソースコードの下記の記述は、それぞれ何を意味するでしょうか？

1. `add`関数の引数`int * a`
2. `add`関数内の` * a`の記述
3. `main`関数において、`add`関数を呼び出す時の引数`&a`とはなんでしょうか？

ポインターにおいて、最も重要なことは、**概念**だけでなく、**書き方**を正確に覚えるということです。

非常に残念なことではありますが、伝統的なC言語プログラミングの書き方は副作用のある書き方が多いです。
ポインターを相手関数に渡して、値をセットさせたりするので、値の変化を追うことが非常に難しいです。

## 演習問題2 
(1) 下記のプログラムは、文字列のポインターを関数に渡して、値をセットさせるプログラムです。  
上手く動くと思ったら、動きません。何故でしょう？

```
#include <stdio.h>

void setTitle(char * title){
    *title = "C Study";
}

int main(){
    char title[100];
    setTitle(&title);
    
    printf("title is %s\n", title);
}
```

### 重要なポイント
+ 文字列リテラルの使い所  
文字列リテラルをそのまま変数に代入できるのは、宣言時のみです。  
僕らが使っている高級言語のように、カジュアルに代入出来ません。
+ 配列は、ポインターのように振る舞います。  
intの時は、&を付けましたが、引数に文字配列のポインターが求められる時は、&を付けずに指定します。  
でも、配列は厳密にはポインターではないのです。（そんなの、今覚えなくていいです）
+ 文字列に何らかの操作を行う時は、string.hを使いましょう  
今回は、strcpyという関数を使って、`title`配列に値をコピーします。


## 演習問題3
(1) 副作用のあるソースコードは嫌なものです。そこで先のプログラムを修正して、文字列配列のポインターを戻すようにしてみました。  
このプログラムは、コンパイル出来ますが、タイトル「C Study」が表示できません。何故でしょう？

```
#include <stdio.h>
#include <string.h>

char * getTitle(){
    char title[10] = "C Study";
    return title;
}

int main(){
    char * title = getTitle();
    printf("title is %s\n", title);
}
```

# 参考図書
hanhan1978が学習に用いた本達です。良書厳選。

+ プログラミング言語C
+ Head First C
+ 詳解ポインター
+ エキスパートCプログラミング―知られざるCの深層

